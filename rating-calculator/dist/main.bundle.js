!function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=26)}({26:function(t,e,n){"use strict";n.r(e);const o=[{th:100.5,factor:15,title:"SSS+"},{th:100,factor:14,title:"SSS"},{th:99.99,factor:13.5,title:"SS+"},{th:99.5,factor:13,title:"SS+"},{th:99,factor:12,title:"SS"},{th:98,factor:11,title:"S+"},{th:97,factor:10,title:"S"},{th:94,factor:9.4,title:"AAA"},{th:90,factor:9,title:"AA"},{th:80,factor:8,title:"A"},{th:75,factor:7.5,title:"BBB"},{th:70,factor:7,title:"BB"},{th:60,factor:6,title:"B"},{th:50,factor:5,title:"C"}],i=[{th:100.5,factor:14,title:"SSS+"},{th:100,factor:13.5,title:"SSS"},{th:99.5,factor:13.2,title:"SS+"},{th:99,factor:13,title:"SS"},{th:98,factor:12.7,title:"S+"},{th:97,factor:12.5,title:"S"},{th:94,factor:10.5,title:"AAA"},{th:90,factor:9.5,title:"AA"},{th:80,factor:8.5,title:"A"},{th:75,factor:7.5,title:"BBB"},{th:70,factor:7,title:"BB"},{th:60,factor:6,title:"B"},{th:50,factor:5,title:"C"}];function r(t){return t?i:o}function l(t,e){return r(e).findIndex(e=>t>=e.th)}function c(t,e){const n=l(t,e);return n<0?null:r(e)[n]}function a(t){const e=c(t,!0);return e?e.title:"C"}function s(t,e,n){const o=r(n),i=o.indexOf(e),l=i>=1?o[i-1].th-1e-4:e.th;return[Math.floor(t*e.th*e.factor/100),Math.floor(t*l*e.factor/100)]}function u(t,e){return t>e?-1:Number(t<e)}function d(t,e,n){return u(t[n],e[n])}function f(t,e){return d(t,e,"rating")||d(t,e,"innerLv")||d(t,e,"achievement")}const g=["BASIC","ADVANCED","EXPERT","MASTER","Re:MASTER"],h=new Map([["Re:MASTER","remaster"],["MASTER","master"],["EXPERT","expert"],["ADVANCED","advanced"]]),m=[];for(let t=15;t>=1;t--)15!==t&&m.push(t+"+"),m.push(t.toString());function p(t,e,n){const o=l(t.achievement,e);if(o<=0)return[t.rating,t.achievement];const i=r(e),c=new Map;for(let r=o-1;r>=0;r--){const o=i[r];if(o.title===i[r+1].title)continue;const[l,a]=s(t.innerLv,o,e);a>=n&&c.set(o.title,{minRt:l,rank:o})}return c}function b(t,e,n){const o=[];if(e<=0)return o;const i=t[e-1].rating;for(let r=e;r<t.length;r++){const e=t[r];if(e.achievement<100.5){const t=p(e,n,i);if(!t.size)continue;if(e.nextRanks=t,o.push(e),o.length>=50)break}}return o.sort(function(t){return(e,n)=>{const o=e.nextRanks.values().next().value,i=(o.minRt-t)/(o.rank.th-e.achievement),r=n.nextRanks.values().next().value;return u(i,(r.minRt-t)/(r.rank.th-n.achievement))||d(e,n,"nextRating")||d(e,n,"innerLv")}}(i-10)),o.slice(0,20)}const S=/\bdx\s*:\s*([0-9]+)/,y=/\blv\s*:\s*(\[.+?\])/,v=/\bv\s*:\s*([0-9]+)/,T=/\bn\s*:\s*["'](.+?)['"]\s*[,\}]/,w=/\bnn\s*:\s*["'](.+?)['"]\s*[,\}]/;function E(t){const e=t.match(S),n=t.match(y),o=t.match(v),i=t.match(T),r=t.match(w);if(e&&n&&o&&i)return{dx:parseInt(e[1]),lv:JSON.parse(n[1]),debut:parseInt(o[1]),songName:i[1],nickname:r&&r[1]}}function R(t,e){const[n,o,i,r,l,a]=t.split("\t");if(n&&o&&i&&r&&l&&a){const t=parseFloat(a),s=function(t,e){const n=c(t=Math.min(t,100.5),e);n||console.warn(`Could not find rank for achievement ${t.toFixed(4)}%`);const o=n?n.factor:5;return{factor:o,multiplier:o*t/100}}(t,e);return{songName:n,genre:o,difficulty:i,level:r,chartType:l,achievement:t,multiplier:s.multiplier,rankFactor:s.factor}}}const L=["officialLevelCell"];function x(t){const e=new Map;for(const t of r(!0))e.set(t.title,0);return t.forEach(t=>{const n=a(t.achievement),o=e.get(n);e.set(n,o+1)}),e}function C(t,e,n,o,i,r){const l=document.createElement("tr");let c;return o&&l.classList.add(o),t.forEach((t,n)=>{const o=e||0===n?"th":"td";c=document.createElement(o),c.innerText=t,c.classList.add(i),n<r.length&&c.classList.add(r[n]),l.appendChild(c)}),n&&c.classList.add("totalCell"),l}function k(t,e,n,o){const i=[""];for(const e of r(!0))if(i.push(e.title),e.title===t)break;return e&&i.push("TOTAL"),C(i,!0,e,"",n,o)}function I(t,e,n,o,i,r,l){const c=[t];let a=0;for(const[t,o]of e)if(c.push(o),a+=o,t===n)break;return o&&c.push(a),C(c,!1,o,i,r,l)}function M(t,e,n){e.innerHTML="",n.innerHTML="";const o=new Map;m.forEach(t=>{o.set(t,[])}),t.forEach(t=>{const e=t.level||function(t){const e=Math.floor(t);return t-e>.6?e+"+":e.toString()}(t.innerLv);o.get(e).push(t)});const i=x(t);let r;for(const[t,e]of i)e>0&&(r=t);e.appendChild(k(r,!1,"levelRankCell",L));for(const[t,e]of o)if(e.length>0){const o=x(e);n.appendChild(I(t,o,r,!1,"","levelRankCell",L))}}function B(t,e){return"Link"===t?e.includes("niconico")?"Link(nico)":"Link(org)":t}function A(t,e,n,o){let i=t.get(e);if(i&&i.length>0){if(i.length>1){const t="DX"===o?1:0;if(i=i.filter(e=>e.dx===t),i.length>1){const t=B(e,n);i=i.filter(e=>e.nickname===t)}}if(1===i.length)return i[0]}return console.warn("Could not find song properties for "+e),null}function D(t,e){let n=function(t){if(!t)return 1;const e=parseInt(t);return t.endsWith("+")?e+.7:e}(t.level),o=!0;if(e){const i=g.indexOf(t.difficulty),r=e.lv[i];"number"==typeof r&&(o=r<0,n=Math.abs(r))}if(o){let e=B(t.songName,t.genre);"DX"===t.chartType&&(e+="[dx]"),e+=` - ${t.difficulty} ${t.level}`,console.warn("Missing inner lv data for "+e)}return{...t,estimate:o,innerLv:n,rating:n*t.multiplier}}const N=["orderCell","songTitleCell","difficultyCell","innerLvCell","achievementCell","rankFactorCell","ratingCell"];function P(t,e,n){const o=document.createElement("tr");for(const t of e)o.classList.add(t);return t.forEach((t,e)=>{const i=document.createElement(n?"th":"td");i.innerText=t,i.classList.add("scoreRecordCell"),i.classList.add(N[e]),o.append(i)}),o}function O(t,e,n,o){n.innerHTML="",o.innerHTML="",n.append(function(t){const e=["編號","歌曲","難度","譜面\n定數","達成率","Rank\n係數","Rating"];return t&&(e[e.length-2]="下個\n目標",e[e.length-1]="下個\nRating"),P(e,[],!0)}(e)),t.forEach((t,n)=>{o.append(function(t,e,n){let o=t.innerLv.toFixed(1);t.estimate&&(o="*"+o);const i=e?Array.from(t.nextRanks.keys()).join("\n"):`${a(t.achievement)} (${t.rankFactor})`,r=e?Array.from(t.nextRanks.values()).map(t=>t.minRt).join("\n"):Math.floor(t.rating);return P([n,t.songName,t.difficulty,o,t.achievement.toFixed(4)+"%",i,r],["scoreRecordRow",h.get(t.difficulty)],!1)}(t,e,n+1))})}const q=["qlRankTitleCell","qlThresholdCell"];function j(t,e,n){const o=document.createElement("tr");for(const t of e)o.classList.add(t);return t.forEach((t,e)=>{const i=document.createElement(n||0===e?"th":"td");i.innerText=t,i.classList.add("qlRankFactorCell"),e<q.length&&i.classList.add(q[e]),o.append(i)}),o}const F=[105,117,117,113,116,59,48,48,116,104,106,110,102,115,98,47,104,106,117,105,118,99,47,106,112,48,110,98,106,96,83,98,117,106,111,104,66,111,98,109,122,123,102,115,48,116,100,115,106,113,117,116,96,110,98,106,110,98,106,48,106,111,96,109,119,96,101,121,47,107,116],H=[113,109,118,116];const $=[{title:"",bonus:0},{title:"初心者",bonus:0},{title:"見習い",bonus:100},{title:"駆け出し",bonus:200},{title:"修行中",bonus:300},{title:"初段",bonus:400},{title:"二段",bonus:500},{title:"三段",bonus:600},{title:"四段",bonus:700},{title:"五段",bonus:800},{title:"六段",bonus:900},{title:"七段",bonus:1e3},{title:"八段",bonus:1200},{title:"九段",bonus:1400},{title:"十段",bonus:1600},{title:"皆伝",bonus:1800},{title:"壱皆伝",bonus:2e3},{title:"弐皆伝",bonus:2100},{title:"参皆伝",bonus:2100},{title:"肆皆伝",bonus:2100},{title:"伍皆伝",bonus:2100},{title:"陸皆伝",bonus:2100},{title:"漆皆伝",bonus:2100},{title:"捌皆伝",bonus:2100},{title:"玖皆伝",bonus:2100},{title:"拾皆伝",bonus:2100}],V=[{title:"",bonus:0},{title:"初心者",bonus:0},{title:"見習い",bonus:250},{title:"駆け出し",bonus:500},{title:"修行中",bonus:750},{title:"初段",bonus:1e3},{title:"二段",bonus:1200},{title:"三段",bonus:1400},{title:"四段",bonus:1500},{title:"五段",bonus:1600},{title:"六段",bonus:1700},{title:"七段",bonus:1800},{title:"八段",bonus:1850},{title:"九段",bonus:1900},{title:"十段",bonus:1950},{title:"皆伝",bonus:2e3},{title:"壱皆伝",bonus:2010},{title:"弐皆伝",bonus:2020},{title:"参皆伝",bonus:2030},{title:"肆皆伝",bonus:2040},{title:"伍皆伝",bonus:2050},{title:"陸皆伝",bonus:2060},{title:"漆皆伝",bonus:2070},{title:"捌皆伝",bonus:2080},{title:"玖皆伝",bonus:2090},{title:"拾皆伝",bonus:2100}];const _=new URLSearchParams(document.location.search),X=_.get("gameVersion"),J=document.querySelector(".quickLookup"),U=document.getElementById("gameVersion"),z=document.getElementById("innerLvInput"),G=document.getElementById("playerScoreInput");let W=0;function K(){return U.value===14..toString()}function Q(){const t=function(t){const e=window.localStorage.getItem(t);if(console.log("Reading cache["+t+"] ->",e),!e)return e;const n=JSON.parse(e),o=new Date(n.date);return new Date-o>31536e6&&console.warn('Cache of "'+t+'" is over 1 year old.'),n.content}(K()?"dxPlusInnerLv":"dxInnerLv");t&&(z.value=t),function(t,e,n){e.innerHTML="",n.innerHTML="",e.appendChild(j(["Rank","達成率","係數","倍率 (係數 × 達成率)"],[],!0));const o=r(t),i=o.findIndex(t=>"A"===t.title)+1;o.slice(0,i).forEach((t,e,o)=>{const i=t.th*t.factor/100,r=e>0?(o[e-1].th-1e-4)*t.factor/100:i,l=i.toFixed(3),c=r.toFixed(3),a=l!==c?`${l} - ${c}`:l;n.appendChild(j([t.title,t.th,t.factor,a],[],!1))})}(K(),document.getElementById("quickLookupThead"),document.getElementById("quickLookupTbody"))}function Y(t){const e=t=>{const e=new Map;for(const n of t){const t=E(n);t&&(e.has(t.songName)||e.set(t.songName,[]),e.get(t.songName).push(t))}return e};return new Promise(n=>{let o=z.value.split("\n");o.length>1?n(e(o)):(console.log("Magic happening..."),fetch(function(t){const e=F.map(t=>t-1);return t&&e.splice(e.length-3,0,...H.map(t=>t-1)),String.fromCharCode(...e)}(t)).then(t=>t.text()).then(t=>{z.value=t,n(e(t.split("\n")))}))})}async function Z(){const t=K();console.log("isDxPlus "+t);const e=await Y(t);if(console.log("Inner Level:"),console.log(e),e.size>600){!function(t,e){console.log("Updating cache["+t+"]");const n={date:new Date,content:e};window.localStorage.setItem(t,JSON.stringify(n))}(t?"dxPlusInnerLv":"dxInnerLv",z.value)}const n=await async function(t,e){const n=t.split("\n"),o=[];for(const t of n){const n=R(t,e);n&&o.push(n)}return o}(G.value,t);if(console.log("Player Score:"),console.log(n),n.length){const o=t?14:13,i=await async function(t,e,n){const o=[],i=[];for(const r of e){const e=A(t,r.songName,r.genre,r.chartType);let l="STANDARD"===r.chartType;e&&(l=e.debut!==n);const c=D(r,e);l?i.push(c):o.push(c)}o.sort(f),i.sort(f);let r=0;const l=Math.min(15,o.length);for(let t=0;t<l;t++)r+=Math.floor(o[t].rating);let c=0;const a=Math.min(25,i.length);for(let t=0;t<a;t++)c+=Math.floor(i[t].rating);return{totalRating:r+c,newSongScores:o,newSongsRating:r,newTopSongCount:l,oldSongScores:i,oldSongsRating:c,oldTopSongCount:a}}(e,n,o);console.log("Rating Data:"),console.log(i);const r=W>0?function(t,e){return(e?V:$)[t]}(W,t):null;r&&(i.totalRating+=r.bonus,document.querySelector("#gradeTitle").innerText=r.title,document.querySelector("#gradeBonus").innerText=r.bonus,document.querySelector("#gradeRating").classList.remove("hidden"));document.getElementById("totalRating").innerText=i.totalRating;document.getElementById("newSongsRating").innerText=i.newSongsRating;document.getElementById("oldSongsRating").innerText=i.oldSongsRating;const l=i.newSongScores.slice(0,i.newTopSongCount),c=i.oldSongScores.slice(0,i.oldTopSongCount),a=[].concat(l,c);M(a,document.getElementById("lrDistThead"),document.getElementById("lrDistTbody")),function(t,e,n){e.innerHTML="",n.innerHTML="";const o=new Map,i=[].concat(g);i.reverse(),i.forEach(t=>{o.set(t,[])}),t.forEach(t=>{o.get(t.difficulty).push(t)});const r=x(t);let l;for(const[t,e]of r)e>0&&(l=t);e.appendChild(k(l,!0,"diffRankCell",["difficultyRankDistHead"]));for(const[t,e]of o)if(e.length>0){const o=x(e);n.appendChild(I(t,o,l,!0,h.get(t),"diffRankCell",[]))}}(a,document.getElementById("drDistThead"),document.getElementById("drDistTbody")),O(l,!1,document.getElementById("newTopSongsThead"),document.getElementById("newTopSongsTbody")),O(c,!1,document.getElementById("oldTopSongsThead"),document.getElementById("oldTopSongsTbody"));const s=b(i.newSongScores,i.newTopSongCount,t),u=b(i.oldSongScores,i.oldTopSongCount,t);O(s,!0,document.getElementById("newCandidateSongsThead"),document.getElementById("newCandidateSongsTbody")),O(u,!0,document.getElementById("oldCandidateSongsThead"),document.getElementById("oldCandidateSongsTbody"));const d=document.querySelector(".outputArea");d.classList.remove("hidden"),d.scrollIntoView({behavior:"smooth"})}J.classList.remove("hidden")}if(document.getElementById("calculateRatingBtn").addEventListener("click",async t=>{t.preventDefault(),Z()}),X&&(U.value=X===14..toString()?14:13),Q(),U.addEventListener("change",Q),"hide"===_.get("quickLookup")&&J.classList.add("hidden"),window.opener){window.addEventListener("message",t=>{if(console.log(t.origin,t.data),"https://maimaidx-eng.com"===t.origin||"https://maimaidx.jp"===t.origin){let e;switch(t.data.action){case"gameVersion":e=parseInt(t.data.payload),e>=14&&(U.value=14);break;case"playerGrade":e=parseInt(t.data.payload),e&&(W=e);case"replacePlayerScore":G.value=t.data.payload;break;case"appendPlayerScore":G.value+=t.data.payload+"\n";break;case"calculateRating":Z()}}});const t=document.referrer&&new URL(document.referrer).origin;t?window.opener.postMessage("ready",t):(window.opener.postMessage("ready","https://maimaidx-eng.com"),window.opener.postMessage("ready","https://maimaidx.jp"))}}});
!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=29)}([,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getRankTitle=t.getRankByAchievement=t.getRankIndexByAchievement=t.getRankDefinitions=void 0;const o=[{th:100.5,factor:15,title:"SSS+"},{th:100,factor:14,title:"SSS"},{th:99.99,factor:13.5,title:"SS+"},{th:99.5,factor:13,title:"SS+"},{th:99,factor:12,title:"SS"},{th:98,factor:11,title:"S+"},{th:97,factor:10,title:"S"},{th:94,factor:9.4,title:"AAA"},{th:90,factor:9,title:"AA"},{th:80,factor:8,title:"A"},{th:75,factor:7.5,title:"BBB"},{th:70,factor:7,title:"BB"},{th:60,factor:6,title:"B"},{th:50,factor:5,title:"C"}],i=[{th:100.5,factor:14,title:"SSS+"},{th:100,factor:13.5,title:"SSS"},{th:99.5,factor:13.2,title:"SS+"},{th:99,factor:13,title:"SS"},{th:98,factor:12.7,title:"S+"},{th:97,factor:12.5,title:"S"},{th:94,factor:10.5,title:"AAA"},{th:90,factor:9.5,title:"AA"},{th:80,factor:8.5,title:"A"},{th:75,factor:7.5,title:"BBB"},{th:70,factor:7,title:"BB"},{th:60,factor:6,title:"B"},{th:50,factor:5,title:"C"}];function r(e){return e?i:o}function a(e,t){return r(t).findIndex(t=>e>=t.th)}function c(e,t){const n=a(e,t);return n<0?null:r(t)[n]}t.getRankDefinitions=r,t.getRankIndexByAchievement=a,t.getRankByAchievement=c,t.getRankTitle=function(e){const t=c(e,!0);return t?t.title:"C"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DX_PLUS_GAME_VERSION=t.DX_GAME_VERSION=t.SSSPLUS_MIN_ACHIEVEMENT=t.OFFICIAL_LEVELS=t.DIFFICULTY_CLASSNAME_MAP=t.DIFFICULTIES=void 0,t.DIFFICULTIES=["BASIC","ADVANCED","EXPERT","MASTER","Re:MASTER"],t.DIFFICULTY_CLASSNAME_MAP=new Map([["Re:MASTER","remaster"],["MASTER","master"],["EXPERT","expert"],["ADVANCED","advanced"]]);t.OFFICIAL_LEVELS=[];for(let e=15;e>=1;e--)15!==e&&t.OFFICIAL_LEVELS.push(e+"+"),t.OFFICIAL_LEVELS.push(e.toString());t.SSSPLUS_MIN_ACHIEVEMENT=100.5,t.DX_GAME_VERSION=13,t.DX_PLUS_GAME_VERSION=14},,,,,function(e,t,n){"use strict";function o(e,t){return e>t?-1:Number(e<t)}function i(e,t,n){return o(e[n],t[n])}Object.defineProperty(t,"__esModule",{value:!0}),t.getSongsByNextRatingComparator=t.compareSongsByRating=void 0,t.compareSongsByRating=function(e,t){return i(e,t,"rating")||i(e,t,"level")||i(e,t,"achievement")},t.getSongsByNextRatingComparator=function(e){return(t,n)=>{const r=t.nextRanks.values().next().value,a=(r.minRt-e)/(r.rank.th-t.achievement),c=n.nextRanks.values().next().value;return o(a,(c.minRt-e)/(c.rank.th-n.achievement))||o(r,c)||i(t,n,"level")}}},,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function c(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}l((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(30),r=n(31),a=n(33),c=n(34),l=n(35),s=n(36),u=n(37),d=n(38),f=n(39),g=n(40),S=n(2),h=new URLSearchParams(document.location.search),m=h.get("gameVersion"),p=document.querySelector(".quickLookup"),v=document.getElementById("gameVersion"),y=document.getElementById("innerLvInput"),b=document.getElementById("playerScoreInput");let E=0;function I(){return v.value===S.DX_PLUS_GAME_VERSION.toString()}function R(){u.calculateRankMultipliers(I(),document.getElementById("quickLookupThead"),document.getElementById("quickLookupTbody"))}function L(){return o(this,void 0,void 0,(function*(){const e=I();console.log("isDxPlus "+e);const t=yield function(e){const t=e=>{const t=e.split("\n"),n=new Map;for(const e of t){const t=c.parseInnerLevelLine(e);t&&(n.has(t.songName)||n.set(t.songName,[]),n.get(t.songName).push(t))}return n};return new Promise(n=>{const o=y.value;if(o.length>0)return void n(t(o));const r=e?"dxPlusInnerLv":"dxInnerLv",a=i.readFromCache(r);if(a)return y.value=a,void n(t(a));console.log("Magic happening..."),fetch(l.iWantSomeMagic(e)).then(e=>e.text()).then(e=>{y.value=e,n(t(e))})})}(e);if(console.log("Inner Level:"),console.log(t),t.size>600){const t=e?"dxPlusInnerLv":"dxInnerLv";i.writeToCache(t,y.value)}const n=yield function(e,t){return o(this,void 0,void 0,(function*(){const n=e.split("\n"),o=[];for(const e of n){const n=s.parseScoreLine(e,t);n&&o.push(n)}return o}))}(b.value,e);if(console.log("Player Score:"),console.log(n),n.length){const o=e?S.DX_PLUS_GAME_VERSION:S.DX_GAME_VERSION,i=yield f.analyzePlayerRating(t,n,o);console.log("Rating Data:"),console.log(i);const c=E>0?a.getGradeByIndex(E,e):null;c&&(i.totalRating+=c.bonus,document.getElementById("gradeTitle").innerText=c.title,document.getElementById("gradeBonus").innerText=c.bonus.toString(),document.getElementById("gradeRating").classList.remove("hidden"));document.getElementById("totalRating").innerText=i.totalRating.toString();document.getElementById("newSongsRating").innerText=i.newSongsRating.toString();document.getElementById("oldSongsRating").innerText=i.oldSongsRating.toString();const l=i.newSongScores.slice(0,i.newTopSongCount),s=i.oldSongScores.slice(0,i.oldTopSongCount),u=[].concat(l,s);d.renderRankDistributionPerLevel(u,document.getElementById("lrDistThead"),document.getElementById("lrDistTbody")),d.renderRankDistributionPerDifficulty(u,document.getElementById("drDistThead"),document.getElementById("drDistTbody")),g.renderSongScores(l,!1,document.getElementById("newTopSongsThead"),document.getElementById("newTopSongsTbody")),g.renderSongScores(s,!1,document.getElementById("oldTopSongsThead"),document.getElementById("oldTopSongsTbody"));const h=r.getCandidateSongs(i.newSongScores,i.newTopSongCount,e),m=r.getCandidateSongs(i.oldSongScores,i.oldTopSongCount,e);g.renderSongScores(h,!0,document.getElementById("newCandidateSongsThead"),document.getElementById("newCandidateSongsTbody")),g.renderSongScores(m,!0,document.getElementById("oldCandidateSongsThead"),document.getElementById("oldCandidateSongsTbody"));const p=document.querySelector(".outputArea");p.classList.remove("hidden"),p.scrollIntoView({behavior:"smooth"})}p.classList.remove("hidden")}))}if(document.getElementById("calculateRatingBtn").addEventListener("click",e=>o(void 0,void 0,void 0,(function*(){e.preventDefault(),L()}))),m&&(v.value=m===S.DX_PLUS_GAME_VERSION.toString()?S.DX_PLUS_GAME_VERSION.toString():S.DX_GAME_VERSION.toString()),R(),v.addEventListener("change",R),"hide"===h.get("quickLookup")&&p.classList.add("hidden"),window.opener){window.addEventListener("message",e=>{if(console.log(e.origin,e.data),"https://maimaidx-eng.com"===e.origin||"https://maimaidx.jp"===e.origin){let t;switch(e.data.action){case"gameVersion":t=parseInt(e.data.payload),t>=S.DX_PLUS_GAME_VERSION&&(v.value=S.DX_PLUS_GAME_VERSION.toString());break;case"playerGrade":t=parseInt(e.data.payload),t&&(E=t);break;case"replacePlayerScore":b.value=e.data.payload;break;case"appendPlayerScore":b.value+=e.data.payload+"\n";break;case"calculateRating":L()}}});const e=document.referrer&&new URL(document.referrer).origin;e?window.opener.postMessage("ready",e):(window.opener.postMessage("ready","https://maimaidx-eng.com"),window.opener.postMessage("ready","https://maimaidx.jp"))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.writeToCache=t.readFromCache=void 0;t.readFromCache=function(e){const t=window.localStorage.getItem(e);if(console.log("Reading cache["+e+"] ->",t),!t)return t;const n=JSON.parse(t),o=new Date(n.date);return(new Date).valueOf()-o.valueOf()>31536e6&&console.warn('Cache of "'+e+'" is over 1 year old.'),n.content},t.writeToCache=function(e,t){console.log("Updating cache["+e+"]");const n={date:new Date,content:t};window.localStorage.setItem(e,JSON.stringify(n))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCandidateSongs=void 0;const o=n(1),i=n(32),r=n(7),a=n(2);function c(e,t,n){const r=o.getRankIndexByAchievement(e.achievement,t),a=new Map;if(r<=0)return a;const c=o.getRankDefinitions(t);for(let o=r-1;o>=0;o--){const r=c[o];if(r.title===c[o+1].title)continue;const[l,s]=i.calculateRatingRange(e.level,r,t);s>=n&&a.set(r.title,{minRt:l,rank:r})}return a}t.getCandidateSongs=function(e,t,n){const o=[];if(t<=0)return o;const i=e[t-1].rating;for(let r=t;r<e.length;r++){const t=e[r];if(t.achievement<a.SSSPLUS_MIN_ACHIEVEMENT){const e=c(t,n,i);if(!e.size)continue;if(t.nextRanks=e,o.push(t),o.length>=50)break}}return o.sort(r.getSongsByNextRatingComparator(i-10)),o.slice(0,20)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateRatingRange=void 0;const o=n(1);t.calculateRatingRange=function(e,t,n){const i=o.getRankDefinitions(n),r=i.indexOf(t),a=r>=1?i[r-1].th-1e-4:t.th;return[Math.floor(e*t.th*t.factor/100),Math.floor(e*a*t.factor/100)]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getGradeByIndex=void 0;const o=[{title:"",bonus:0},{title:"初心者",bonus:0},{title:"見習い",bonus:100},{title:"駆け出し",bonus:200},{title:"修行中",bonus:300},{title:"初段",bonus:400},{title:"二段",bonus:500},{title:"三段",bonus:600},{title:"四段",bonus:700},{title:"五段",bonus:800},{title:"六段",bonus:900},{title:"七段",bonus:1e3},{title:"八段",bonus:1200},{title:"九段",bonus:1400},{title:"十段",bonus:1600},{title:"皆伝",bonus:1800},{title:"壱皆伝",bonus:2e3},{title:"弐皆伝",bonus:2100},{title:"参皆伝",bonus:2100},{title:"肆皆伝",bonus:2100},{title:"伍皆伝",bonus:2100},{title:"陸皆伝",bonus:2100},{title:"漆皆伝",bonus:2100},{title:"捌皆伝",bonus:2100},{title:"玖皆伝",bonus:2100},{title:"拾皆伝",bonus:2100}],i=[{title:"",bonus:0},{title:"初心者",bonus:0},{title:"見習い",bonus:250},{title:"駆け出し",bonus:500},{title:"修行中",bonus:750},{title:"初段",bonus:1e3},{title:"二段",bonus:1200},{title:"三段",bonus:1400},{title:"四段",bonus:1500},{title:"五段",bonus:1600},{title:"六段",bonus:1700},{title:"七段",bonus:1800},{title:"八段",bonus:1850},{title:"九段",bonus:1900},{title:"十段",bonus:1950},{title:"皆伝",bonus:2e3},{title:"壱皆伝",bonus:2010},{title:"弐皆伝",bonus:2020},{title:"参皆伝",bonus:2030},{title:"肆皆伝",bonus:2040},{title:"伍皆伝",bonus:2050},{title:"陸皆伝",bonus:2060},{title:"漆皆伝",bonus:2070},{title:"捌皆伝",bonus:2080},{title:"玖皆伝",bonus:2090},{title:"拾皆伝",bonus:2100}];t.getGradeByIndex=function(e,t){return(t?i:o)[e]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseInnerLevelLine=void 0;const o=/\bdx\s*:\s*([0-9]+)/,i=/\blv\s*:\s*(\[.+?\])/,r=/\bv\s*:\s*([0-9]+)/,a=/\bn\s*:\s*["'](.+?)['"]\s*[,\}]/,c=/\bnn\s*:\s*["'](.+?)['"]\s*[,\}]/;t.parseInnerLevelLine=function(e){const t=e.match(o),n=e.match(i),l=e.match(r),s=e.match(a),u=e.match(c);if(t&&n&&l&&s)return{dx:parseInt(t[1]),lv:JSON.parse(n[1]),debut:parseInt(l[1]),songName:s[1],nickname:u&&u[1]}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.iWantSomeMagic=void 0;const o=[105,117,117,113,116,59,48,48,116,104,106,110,102,115,98,47,104,106,117,105,118,99,47,106,112,48,110,98,106,96,83,98,117,106,111,104,66,111,98,109,122,123,102,115,48,116,100,115,106,113,117,116,96,110,98,106,110,98,106,48,106,111,96,109,119,96,101,121,47,107,116],i=[113,109,118,116];t.iWantSomeMagic=function(e){const t=o.map(e=>e-1);return e&&t.splice(t.length-3,0,...i.map(e=>e-1)),String.fromCharCode(...t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseScoreLine=void 0;const o=n(1),i=n(2);function r(e){if(!e)return 1;const t=parseInt(e);return e.endsWith("+")?t+.7:t}t.parseScoreLine=function(e,t){const[n,a,c,l,s,u]=e.split("\t");if(n&&a&&c&&l&&s&&u){const e=parseFloat(u),d=function(e,t){e=Math.min(e,i.SSSPLUS_MIN_ACHIEVEMENT);const n=o.getRankByAchievement(e,t);n||console.warn(`Could not find rank for achievement ${e.toFixed(4)}%`);const r=n?n.factor:5;return{factor:r,multiplier:r*e/100}}(e,t);return{songName:n,genre:a,difficulty:c,level:r(l),levelIsEstimate:!0,chartType:s,achievement:e,multiplier:d.multiplier,rankFactor:d.factor}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateRankMultipliers=void 0;const o=n(1),i=["qlRankTitleCell","qlThresholdCell"];function r(e,t,n){const o=document.createElement("tr");for(const e of t)o.classList.add(e);return e.forEach((e,t)=>{const r=document.createElement(n||0===t?"th":"td");r.innerText=e,r.classList.add("qlRankFactorCell"),t<i.length&&r.classList.add(i[t]),o.append(r)}),o}t.calculateRankMultipliers=function(e,t,n){t.innerHTML="",n.innerHTML="",t.appendChild(r(["Rank","達成率","係數","倍率 (係數 × 達成率)"],[],!0));const i=o.getRankDefinitions(e),a=i.findIndex(e=>"A"===e.title)+1;i.slice(0,a).forEach((e,t,o)=>{const i=e.th*e.factor/100,a=t>0?(o[t-1].th-1e-4)*e.factor/100:i,c=i.toFixed(3),l=a.toFixed(3),s=c!==l?`${c} - ${l}`:c;n.appendChild(r([e.title,e.th.toString(),e.factor.toString(),s],[],!1))})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renderRankDistributionPerDifficulty=t.renderRankDistributionPerLevel=void 0;const o=n(1),i=n(2),r=["officialLevelCell"];function a(e){const t=new Map;for(const e of o.getRankDefinitions(!0))t.set(e.title,0);return e.forEach(e=>{const n=o.getRankTitle(e.achievement),i=t.get(n);t.set(n,i+1)}),t}function c(e,t,n,o,i,r){const a=document.createElement("tr");let c;return o&&a.classList.add(o),e.forEach((e,n)=>{const o=t||0===n?"th":"td";c=document.createElement(o),c.innerText=e,c.classList.add(i),n<r.length&&c.classList.add(r[n]),a.appendChild(c)}),n&&c.classList.add("totalCell"),a}function l(e,t,n,i){const r=[""];for(const t of o.getRankDefinitions(!0))if(r.push(t.title),t.title===e)break;return t&&r.push("TOTAL"),c(r,!0,t,"",n,i)}function s(e,t,n,o,i,r,a){const l=[e];let s=0;for(const[e,o]of t)if(l.push(o),s+=o,e===n)break;return o&&l.push(s.toString()),c(l,!1,o,i,r,a)}t.renderRankDistributionPerLevel=function(e,t,n){t.innerHTML="",n.innerHTML="";const o=new Map;i.OFFICIAL_LEVELS.forEach(e=>{o.set(e,[])}),e.forEach(e=>{const t=function(e){const t=Math.floor(e);return e-t>.6?t+"+":t.toString()}(e.level);o.get(t).push(e)});const c=a(e);let u;for(const[e,t]of c)t>0&&(u=e);t.appendChild(l(u,!1,"levelRankCell",r));for(const[e,t]of o)if(t.length>0){const o=a(t);n.appendChild(s(e,o,u,!1,"","levelRankCell",r))}},t.renderRankDistributionPerDifficulty=function(e,t,n){t.innerHTML="",n.innerHTML="";const o=new Map,r=[].concat(i.DIFFICULTIES);r.reverse(),r.forEach(e=>{o.set(e,[])}),e.forEach(e=>{o.get(e.difficulty).push(e)});const c=a(e);let u;for(const[e,t]of c)t>0&&(u=e);t.appendChild(l(u,!0,"diffRankCell",["difficultyRankDistHead"]));for(const[e,t]of o)if(t.length>0){const o=a(t);n.appendChild(s(e,o,u,!0,i.DIFFICULTY_CLASSNAME_MAP.get(e),"diffRankCell",[]))}}},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function c(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}l((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.analyzePlayerRating=void 0;const i=n(7),r=n(2);function a(e){return"DX"===e}function c(e,t,n){return"Link"===e?t.includes("niconico")?"Link(nico)":"Link(org)":a(n)?e+"[dx]":e}function l(e,t,n,o){let i=e.get(t);if(i&&i.length>0){if(i.length>1){const e=a(o)?1:0;if(i=i.filter(t=>t.dx===e),i.length>1){const e=c(t,n);i=i.filter(t=>t.nickname===e)}}if(1===i.length)return i[0]}return console.warn("Could not find song properties for "+t),null}function s(e,t){if(t){const n=r.DIFFICULTIES.indexOf(e.difficulty),o=t.lv[n];"number"==typeof o&&(e.levelIsEstimate=o<0,e.level=Math.abs(o))}if(e.levelIsEstimate){const t=c(e.songName,e.genre,e.chartType)+" - "+e.difficulty+" "+e.level;console.warn("Missing inner lv data for "+t)}return Object.assign(Object.assign({},e),{rating:e.level*e.multiplier})}t.analyzePlayerRating=function(e,t,n){return o(this,void 0,void 0,(function*(){const o=[],r=[];for(const i of t){const t=l(e,i.songName,i.genre,i.chartType);let a="STANDARD"===i.chartType;t&&(a=t.debut!==n);const c=s(i,t);a?r.push(c):o.push(c)}o.sort(i.compareSongsByRating),r.sort(i.compareSongsByRating);let a=0;const c=Math.min(15,o.length);for(let e=0;e<c;e++)a+=Math.floor(o[e].rating);let u=0;const d=Math.min(25,r.length);for(let e=0;e<d;e++)u+=Math.floor(r[e].rating);return{totalRating:a+u,newSongScores:o,newSongsRating:a,newTopSongCount:c,oldSongScores:r,oldSongsRating:u,oldTopSongCount:d}}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.renderSongScores=void 0;const o=n(1),i=n(2),r=["orderCell","songTitleCell","difficultyCell","innerLvCell","achievementCell","rankFactorCell","ratingCell"];function a(e,t,n){const o=document.createElement("tr");for(const e of t)o.classList.add(e);return e.forEach((e,t)=>{const i=document.createElement(n?"th":"td");i.innerText=e,i.classList.add("scoreRecordCell"),i.classList.add(r[t]),o.append(i)}),o}t.renderSongScores=function(e,t,n,r){n.innerHTML="",r.innerHTML="",n.append(function(e){const t=["編號","歌曲","難度","譜面\n定數","達成率","Rank\n係數","Rating"];return e&&(t[t.length-2]="下個\n目標",t[t.length-1]="下個\nRating"),a(t,[],!0)}(t)),e.forEach((e,n)=>{r.append(function(e,t,n){let r=e.level.toFixed(1);e.levelIsEstimate&&(r="*"+r);const c=t?Array.from(e.nextRanks.keys()).join("\n"):`${o.getRankTitle(e.achievement)} (${e.rankFactor})`,l=t?Array.from(e.nextRanks.values()).map(e=>e.minRt).join("\n"):Math.floor(e.rating).toString();return a([n.toString(),e.songName,e.difficulty,r,e.achievement.toFixed(4)+"%",c,l],["scoreRecordRow",i.DIFFICULTY_CLASSNAME_MAP.get(e.difficulty)],!1)}(e,t,n+1))})}}]);